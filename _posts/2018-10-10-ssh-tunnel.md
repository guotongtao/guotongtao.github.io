---  
layout: post  
title: "ssh隧道及代理"  
categories: ssh  
tags: tunnel socks5  
---  
* content  
{:toc}  

ssh是用来远程登录主机的作用大家都知道，而且传输的内容全部经过加密处理也是大家喜欢其的主要因素。但其实ssh能做的更多，例如作为代理服务器。  




通过ssh 的-D参数，我们可以在本地搭建一个socks5服务器，具体使用方法如下：  
ssh -qTNf -D 127.0.0.1:12345 test@222.333.444.555  
其中  

> * -q表示该命令进入安静模式  
> * -T是指该命令不占用shell  
> * -N是指该命令不执行远程命令  
> * -f是指该命令在后台运行  
> * -D是该命令重要参数，他的后面跟着socks5服务器的地址与端口 最后就是远程服务器用户名和地址  

执行完该命令后，我们需要在浏览器中设置代理服务器，地址和端口就是上面提到的，然后记得选择socks5协议。那么以后每浏览一个页面，都会先经过代理服务器，然后再去请求页面，接着页面先到达代理服务器，最后才返回我们自己的浏览器。过程好像变得复杂了，但是这样的作用是什么呢，很常见，例如有一些校园网是限制ipv4流量的，如果我们找到一台支持ipv6的远程服务器，而且校园网大部分都支持ipv6，那么我们就能通过建立ipv6代理服务器来无流量限制上网了。再者，如果我们能找到外国的免费服务器，能让我们通过ssh登录，那么我们通过建立代理服务器来翻墙了，翻墙后能做的事情就请读者自行脑补吧。  
  接下来继续讲的是ssh的端口映射功能，这个也相当好用，例如我们在家如果想访问公司或学校的资源，我们需要先登录一台拥有公网ip的服务器，然后在访问局域网的主机，譬如，我们是A主机，需要访问学校的C主机，而只有学校B主机有公网ip，我们需要先登录B主机，然后才能访问C主机。过程很麻烦，这时我们就需要做一个端口映射了，而这个ssh也能帮我们完成。具体命令如下：  
ssh -N -f -L 127.0.0.1:12345:10.21.0.34:22 test@12.3..4.5  
其中-N，-f作用上面已经讲了，这里最重要的是-L命令，它作用是做本地映射，使得远程服务器的端口相当于本地某自定义的端口，如上面的命令，本地的12345端口就相当于10.21.0.34的22端口，以后我只需要使用ssh user@127.0.0.1 -p12345命令就能登录10.21.0.34了，注意user是10.21.0.34的用户，最后就是我们所使用的中间服务器，这个地址需要是我们直接访问到的。其实上面所说的A主机就是127.0.0.1，B主机就是12.3.4.5，C主机就是10.21.0.34。当然了，有本地映射肯定有远程映射，就是把-L换成-R，这样我们访问远程主机的端口就相当于访问本地的端口，但我没发现该功能的更多用途。  

如果你没有什么中间服务器，只是想做个端口映射，那也很简单，如下：  
ssh -N -f -L 12345:12.3.4.5:22 test@12.3.4.5  
就是把远程服务器地址写成中间服务器地址就完事了。  
192.168.59.23 客户端  
192.168.59.21 最终服务器  
192.168.59.24 中间服务器  
192.168.59.23：  
ssh  -N -f -L 2222:192.168.59.21:22 root@192.168.59.24 //输入24密码  
ssh -p 2222 127.0.0.1 //输入21的密码，登入到21  
学习完ssh这些用法后有没有对ssh产生无比崇敬的心情的，各种膜拜啊。  
![20200509102933](https://guott.oss-cn-beijing.aliyuncs.com/img/20200509102933.png)  