---
layout: post
title: "elk部署"
categories: elasticsearch logstash kibana
tags: elk
---
* content
{:toc}


## 1.elasticsearch

elasticsearch运行需要java

 yum install java

[root@zys-yunwei ~]# java -version
openjdk version "1.8.0_242"
OpenJDK Runtime Environment (build 1.8.0_242-b08)
OpenJDK 64-Bit Server VM (build 25.242-b08, mixed mode)

下载中心

https://elasticsearch.cn/download/

**下载elasticsearch**

https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.6.1-x86_64.rpm

**安装**

 rpm -ivh elasticsearch-7.6.1-x86_64.rpm 

**配置**

vi /etc/elasticsearch/elasticsearch.yml 

```
cluster.initial_master_nodes: ["server1"]
cluster.name: zy-application
node.name: server1
#path.data: /storage/elasticsearch/
#path.logs: /storage/elasticsearch/
#bootstrap.mlockall: true
network.host: 0.0.0.0
http.port: 9200
http.cors.enabled: true
http.cors.allow-origin: "*"
```



**错误**

[2020-03-20T18:04:40,144][ERROR][o.e.b.Bootstrap          ] [server1] node validation exception
[1] bootstrap checks failed
[1]: the default discovery settings are unsuitable for production use; at least one of [discovery.seed_hosts, discovery.seed_providers, cluster.initial_master_nodes] must be configured

 解决：

vi /etc/elasticsearch/elasticsearch.yml 

cluster.initial_master_nodes: ["server1"]

**启动**

systemctl start elasticsearch

## 2. elasticsearch-head（选配）

### **2.1 安装nodejs**

curl --silent --location https://rpm.nodesource.com/setup_10.x | sudo bash

 yum install  nodejs

添加镜像源

npm install -g cnpm --registry=https://registry.npm.taobao.org

### **2.2 安装grunt** 

cnpm install -g grunt-cli

### **2.3 安装elasticsearch-head**

**下载**

下载地址：https://github.com/mobz/elasticsearch-head/archive/v5.0.0.tar.gz

**解压**

执行命令：

tar -zxvf elasticsearch-head-5.0.0.tar.gz -C /usr/local/

ln -s /usr/local/elasticsearch-head-5.0.0/ /usr/local/elasticsearch-head

**配置**

vi /usr/local/elasticsearch-head/Gruntfile.js

修改：

 

​                connect: {

​                        server: {

​                                options: {

​                                        hostname: '0.0.0.0',

​                                        port: 9100,

​                                        base: '.',

​                                        keepalive: true

​                                }

​                        }

​                }

**安装**

yum install -y bzip2

cd /usr/local/elasticsearch-head

cnpm install

**启动**

nohup grunt server >> /var/log/elasticsearch/elasticsearch-head.log 2>&1 &

## 3.kibana（选配）

**rpm安装**

 rpm -ivh kibana-7.6.1-x86_64.rpm

**配置**

 mkdir /var/log/kibana/

chown -R  kibana kibana

 vi /etc/kibana/kibana.yml

```
#监听端口
server.port: 5601
#监听地址
server.host: "192.168.107.170"
#elasticsearch服务器地址
elasticsearch.hosts: ["http://192.168.107.170:9200"]
#修改为中文
i18n.locale: "zh-CN"
logging.dest: "/var/log/kibana/kibana.log"
```

**启动**

```
systemctl start kibana
```

## 4.logstash

**安装**

rpm  -ivh logstash-7.6.1.rpm

**配置**

vim /etc/logstash/conf.d/nginx-log.conf

```python
input {
    file {
        #日志路径
        path => "/usr/local/nginx/logs/access.log"
        #类型，自定义，在进行多个日志收集存储时可以通过该项进行判断输出
        type => "nginx"
        #logstash 从什么位置开始读取文件数据，默认是结束位置，也就是说 logstash 进程会以类似 tail -F 的形式运行。如果你是要导入原有数据，把这个设定改成 "beginning"，logstash 进程就从头开始读取，类似 less +F 的形式运行。
        start_position => "beginning"
        #logstash 每隔多久检查一次被监听文件状态（是否有更新），默认是 1 秒
        stat_interval => "2"
    }
}

output {
    elasticsearch {
        #elasticsearch服务器地址
        hosts => ["192.168.107.170:9200"]
        #索引名称
        index => "logstash-%{type}-%{+YYYY.MM.dd}"
    }
}
```



**启动**

systemctl start logstash